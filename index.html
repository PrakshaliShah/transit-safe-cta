<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CTA Silent Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* Custom Styling for "Advanced" Feel */
        body { 
            padding-top: 2rem; 
            background-color: #11191f; /* Deep blue-black */
        }
        .container { max-width: 600px; }
        
        /* The Result Box */
        .status-box { 
            background-color: #1e293b; 
            padding: 25px; 
            border-radius: 12px; 
            margin-top: 20px; 
            border-left: 6px solid #007bff; /* Blue accent bar */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }

        /* Emergency Button Colors */
        .btn-danger { background-color: #ef4444; border-color: #ef4444; color: white; }
        .btn-warning { background-color: #f97316; border-color: #f97316; color: white; }
        .btn-medical { background-color: #3b82f6; border-color: #3b82f6; color: white; }
        .btn-alert   { background-color: #a855f7; border-color: #a855f7; color: white; }

        /* Animations */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Pulse effect for the scanning button */
        button[aria-busy="true"] {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>

    <main class="container">
        <hgroup style="text-align: center; margin-bottom: 2rem;">
            <h1>üöÜ CTA Silent Tracker</h1>
            <p style="color: #94a3b8;">Secure ‚Ä¢ Real-Time ‚Ä¢ Discreet</p>
        </hgroup>

        <article>
            <label for="routeSelect"><strong>Select Your Line</strong></label>
            <select id="routeSelect">
                <option value="Red">Red Line</option>
                <option value="Blue">Blue Line</option>
                <option value="Brn">Brown Line</option>
                <option value="G">Green Line</option>
                <option value="Org">Orange Line</option>
                <option value="P">Purple Line</option>
                <option value="Pink">Pink Line</option>
                <option value="Y">Yellow Line</option>
            </select>

            <button onclick="findTrain()" id="findBtn" style="margin-top: 10px; font-weight: bold;">
                üìç Locate My Train
            </button>
        </article>

        <div id="resultBox" class="status-box" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="trainId" style="margin: 0; color: #fff;">Scanning...</h3>
                <small id="confBadge" style="background:#333; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem;">LIVE</small>
            </div>
            
            <p id="distInfo" style="margin-top: 10px; color: #cbd5e1;">Distance: ...</p>
            
            <hr style="border-color: #334155; margin: 20px 0;">
            
            <p style="font-size: 0.8rem; letter-spacing: 1px; color: #94a3b8; text-transform: uppercase; font-weight: bold;">
                Select Incident Type
            </p>
            
            <div class="grid">
                <button onclick="sendAlert('WEAPON')" class="btn-danger">üî´ Weapon</button>
                <button onclick="sendAlert('FIGHT')" class="btn-warning">üëä Fight</button>
            </div>
            <div class="grid">
                <button onclick="sendAlert('MEDICAL')" class="btn-medical">üöë Medical</button>
                <button onclick="sendAlert('HARASSMENT')" class="btn-alert">‚ö†Ô∏è Harassment</button>
            </div>
        </div>
    </main>

    <script>
        async function findTrain() {
            const route = document.getElementById('routeSelect').value;
            const btn = document.getElementById('findBtn');
            const resultBox = document.getElementById('resultBox');
            
            // 1. UI Loading State
            btn.setAttribute('aria-busy', 'true');
            btn.textContent = 'üõ∞Ô∏è Triangulating GPS...';
            resultBox.style.display = 'none';

            if (!navigator.geolocation) {
                alert("Geolocation is not supported by this browser.");
                btn.setAttribute('aria-busy', 'false');
                btn.textContent = 'üìç Locate My Train';
                return;
            }

            // 2. Get GPS
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                btn.textContent = 'üîÑ Scanning CTA Network...';

                try {
                    // 3. Call Python Backend
                    const response = await fetch(`/find-train/${route}?lat=${lat}&lon=${lon}`);
                    const data = await response.json();

                    // 4. Update UI
                    btn.setAttribute('aria-busy', 'false');
                    btn.textContent = 'üìç Update Location';
                    resultBox.style.display = 'block';

                    if (data.found) {
                        const train = data.closest_train;
                        document.getElementById('trainId').innerText = `‚úÖ Run #${train.run_number}`;
                        document.getElementById('distInfo').innerHTML = `
                            Next Stop: <strong>${train.next_stop}</strong><br>
                            Distance: ${train.distance_meters} meters
                        `;
                        
                        // Update Confidence Badge
                        const badge = document.getElementById('confBadge');
                        if (data.confidence === "High") {
                            badge.style.backgroundColor = "#22c55e"; // Green
                            badge.innerText = "HIGH CONFIDENCE";
                        } else {
                            badge.style.backgroundColor = "#f59e0b"; // Orange
                            badge.innerText = "LOW CONFIDENCE";
                        }

                    } else {
                        document.getElementById('trainId').innerText = "‚ùå No Train Found";
                        document.getElementById('distInfo').innerText = "Could not match your GPS to a live train.";
                        document.getElementById('confBadge').innerText = "ERROR";
                        document.getElementById('confBadge').style.backgroundColor = "#ef4444";
                    }
                } catch (error) {
                    btn.setAttribute('aria-busy', 'false');
                    btn.textContent = 'Retry';
                    alert("Connection Error: " + error);
                }
            }, (error) => {
                btn.setAttribute('aria-busy', 'false');
                btn.textContent = 'üìç Locate My Train';
                alert("GPS Error: Please allow location access.");
            });
        }

        function sendAlert(type) {
            const trainText = document.getElementById('trainId').innerText;
            // Get raw text without the "Next Stop" HTML formatting for the SMS
            const distText = document.getElementById('distInfo').innerText.replace('\n', '. ');
            
            const smsBody = `EMERGENCY: ${type} reported on CTA. ${trainText}. ${distText}. My GPS location is included via carrier.`;
            
            window.location.href = `sms:911?body=${encodeURIComponent(smsBody)}`;
        }
    </script>
</body>
</html>
